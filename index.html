<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>D3 StarMap</title>
    <!-- <link rel="stylesheet" href="lib/normalize.min.css" />
    <script type="text/javascript" src="lib/d3.min.js"></script>
    <script type="text/javascript" src="lib/d3.geo.projection.min.js"></script>
    <script type="text/javascript" src="lib/topojson.v3.min.js"></script> -->
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/normalize/3.0.1/normalize.min.css"
    />
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
    <script src="./scripts.js"></script>
    <style>
      svg {
        background-color: #000000;
      }
      .star {
        fill: #ffffff;
      }
      .graticule {
        fill: none;
        stroke: #cccccc;
        stroke-width: 0.6;
        opacity: 0.8;
      }
      .lines {
        fill: none;
        stroke: #cccccc;
        stroke-width: 0.6;
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <script>
      const cnf = {
        width: 800,
        latitude: 52.6218,
        longtitude: 29.7133,
        date: new Date(),
        stars: {
          size: 5,
          exponent: -0.28,
          data_path: "data/stars.6.json",
        },
        graticule: {
          show: true,
        },
        constellation: {
          show: true,
          data_path: "data/constellations.lines.json",
        },
      };

      // Ширина и высота будущей карты
      var width = cnf.width;
      var height = cnf.width;

      var localZone = -cnf.date.getTimezoneOffset();
      var timeZone = localZone;
      var dtc = new Date(cnf.date.getTime() - (timeZone - localZone) * 60000);
      var zenith = transformDeg(
        getAzimutPoint(dtc, [90, 0], [cnf.latitude, cnf.longtitude]),
        euler["ecliptic"]
      );

      var coordinates = [-zenith[0], -zenith[1], 0];

      console.log(coordinates);

      // Создаём функцию проекции
      var projection = getProjection()
        .scale(width / 2)
        .clipAngle(90)
        .translate([width / 2, height / 2])
        .rotate(coordinates);

      // console.log(projection.center());

      // Создаем функцию, которая будет преобразовывать географические координаты в формат пути для элемента <path>
      var path = d3.geo.path().projection(projection);

      // Создаём элемент <svg>, где и будет рисоваться карта
      var svg = d3
        .select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      // Сетка
      var graticule = d3.geo.graticule().minorStep([15, 10]);
      svg
        .append("path")
        .datum(graticule)
        .attr("class", "graticule")
        .attr("d", path);

      // Создаем элемент группы <g>, в который будут вкладываться все другие элементы
      var g = svg.append("g");

      // Загружаем карту
      d3.json(cnf.stars.data_path, function (error, stars) {
        if (error) {
          console.log(error);
          return;
        }

        // Получаем массив звезд из файла
        var stars = getData(stars, "ecliptic").features;

        // Рисуем звезды
        g.selectAll(".star")
          .data(stars)
          .enter()
          .append("circle")
          .attr("class", "star")
          .attr("opacity", function (d) {
            var geoangle = d3.geo.distance(
              [-coordinates[0], -coordinates[1]],
              d.geometry.coordinates
            );

            if (geoangle > 1.5707963267949) {
              return "0";
            } else {
              return "1.0";
            }
          })
          .attr("r", (d) => starSize(d))
          .attr("cx", (d) => projection(d.geometry.coordinates)[0])
          .attr("cy", (d) => projection(d.geometry.coordinates)[1]);
      });

      // Загружаем созвездия
      d3.json(cnf.constellation.data_path, function (error, lines) {
        if (error) {
          console.log(error);
          return;
        }

        // Получаем массив созвездий из файла
        var lines = getData(lines, "ecliptic").features;

        // Рисуем созвездия
        g.selectAll(".lines")
          .data(lines)
          .enter()
          .append("path")
          .attr("class", "lines")
          .attr("d", path);
      });
    </script>
  </body>
</html>
